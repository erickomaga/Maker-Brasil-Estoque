<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Estoque</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'sans-serif'],
            'display': ['Montserrat', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    .edit-card {
      background-color: #1e293b;
      border-radius: 1rem; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
      border: 1px solid #334155; 
      transition: all 0.3s ease; 
      padding: 1.5rem; 
    }
    .edit-card:hover {
      border-color: #3b82f6; 
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.1); 
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem; 
    }
    .card-title {
      font-family: 'Montserrat', sans-serif; 
      font-size: 1.125rem; 
      font-weight: 600; 
      color: #ffffff; 
      padding-right: 0.5rem; 
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem; 
      border-radius: 9999px; 
      font-size: 0.75rem; 
      font-weight: 600;
      flex-shrink: 0; 
    }
    
    .card-body {
      margin-top: 1rem; 
    }

    .input-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #d1d5db; 
      margin-bottom: 0.5rem;
    }
    
    .stock-input {
      background-color: #0f172a; 
      border: 1px solid #475569; 
      width: 100%; 
      padding: 0.75rem; 
      border-radius: 0.5rem; 
      text-align: center;
      color: #ffffff; 
      font-weight: 600;
      font-size: 1.25rem; 
      transition: all 0.2s ease; 
    }
    .stock-input:focus {
      border-color: #3b82f6; 
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); 
      outline: none;
    }

    .bg-green-600 { background-color: #16a34a; }
    .bg-yellow-400 { background-color: #f59e0b; }
    .text-gray-900 { color: #111827; }
    .bg-orange-500 { background-color: #f97316; }
    .bg-red-600 { background-color: #dc2626; }

  </style>
</head>
<body class="font-sans bg-slate-900 text-gray-200 min-h-screen">
  <header class="bg-slate-900/80 backdrop-blur-lg sticky top-0 z-50 shadow-lg shadow-black/30">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="font-display text-3xl font-bold text-white">Editar Estoque</h1>
      <a href="/" 
         class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold px-5 py-2.5 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 shadow-md hover:shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Voltar
      </a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-10">
    <h2 class="font-display text-3xl font-semibold mb-10 text-center text-gray-300">
      Atualize as Quantidades de Cada Produto
    </h2>

    <section id="infantil" class="py-10">
      <div class="mb-10">
        <h2 class="font-display text-3xl font-bold text-white border-b-2 border-blue-600 inline-block pb-2">Educação Infantil</h2>
      </div>
      <div id="infantil-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </section>

    <section id="fundamental1-2" class="py-10">
      <div class="mb-10">
        <h2 class="font-display text-3xl font-bold text-white border-b-2 border-blue-600 inline-block pb-2">Fundamental I: 1º e 2º Ano</h2>
      </div>
      <div id="fundamental1-2-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </section>

    <section id="fundamental3-5" class="py-10">
      <div class="mb-10">
        <h2 class="font-display text-3xl font-bold text-white border-b-2 border-blue-600 inline-block pb-2">Fundamental I: 3º ao 5º Ano</h2>
      </div>
      <div id="fundamental3-5-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-8"></div>
    </section>


    <div class="mt-12 pt-8 border-t border-slate-700 text-center">
      <button id="salvar" 
              class="inline-flex items-center gap-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-10 py-4 rounded-xl font-semibold text-lg transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg hover:shadow-green-500/30">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
        </svg>
        Salvar Alterações
      </button>
      <p id="mensagem" class="text-sm mt-4 transition-opacity opacity-0"></p>
    </div>
  </main>

  <script>
    function getStatusClass(v) {
      if (v > 100) return 'bg-green-600';
      if (v > 50) return 'bg-yellow-400 text-gray-900';
      if (v > 0) return 'bg-orange-500';
      return 'bg-red-600';
    }
    function getStatusText(v) {
      if (v > 100) return 'Tranquilo';
      if (v > 50) return 'Alerta';
      if (v > 0) return 'Preocupante';
      return 'Estoque Vazio';
    }

    function criarCardEditHTML(p) {
      return `
        <div class="edit-card">
          <div class="card-header">
            <h2 class="card-title">${p.nome}</h2>
            <span class="status-badge ${getStatusClass(p.em_estoque)}">
              ${getStatusText(p.em_estoque)}
            </span>
          </div>

          <div class="card-body">
            <label for="stock-${p.id}" class="input-label">Alterar Quantidade</label>
            <input type="number" min="0" value="${p.em_estoque}" data-id="${p.id}" id="stock-${p.id}"
                   class="stock-input">
          </div>
        </div>
      `;
    }

    async function carregarProdutos() {
      const grids = {
        infantil: document.getElementById("infantil-grid"),
        "fundamental1-2": document.getElementById("fundamental1-2-grid"),
        "fundamental3-5": document.getElementById("fundamental3-5-grid"),
      };

      Object.values(grids).forEach(grid => {
        if (grid) grid.innerHTML = '';
      });

      const res = await fetch('/api/produtos');
      const produtos = await res.json();
      
      produtos.forEach(p => {
        const cardHTML = criarCardEditHTML(p);
        const gridContainer = grids[p.categoria];
        
        if (gridContainer) {
          gridContainer.innerHTML += cardHTML;
        } else {
          console.warn(`Categoria não encontrada para o grid: ${p.categoria}`);
        }
      });
    }

    async function salvarAlteracoes() {
      const inputs = document.querySelectorAll('.stock-input');
      const dados = [];
      inputs.forEach(i => dados.push({
        id: parseInt(i.dataset.id),
        emEstoque: parseInt(i.value),
        necessario: 0 
      }));

      const res = await fetch('/api/atualizar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dados)
      });
      const result = await res.json();

      const msg = document.getElementById('mensagem');
      msg.textContent = result.mensagem;
      msg.classList.remove('opacity-0', 'text-red-400');
      msg.classList.add('text-green-400');
      setTimeout(() => msg.classList.add('opacity-0'), 3000);

      carregarProdutos();
    }

    document.addEventListener('DOMContentLoaded', carregarProdutos);
    document.getElementById('salvar').addEventListener('click', salvarAlteracoes);
  </script>
</body>
</html>